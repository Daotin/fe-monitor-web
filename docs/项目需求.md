# 前端监控数据大屏 - 需求文档 (V1.0 - MVP)

## 1. 引言

### 1.1 背景

`fe-monitor-sdk` 已开发完成，能够收集前端应用的错误、性能及用户行为数据。为了有效利用这些数据，及时发现并解决线上问题，提升应用质量和用户体验，需要开发一个配套的数据可视化与管理平台（数据大屏）。

### 1.2 目的

本需求文档定义了数据大屏项目的 **最小可行产品 (MVP)** 版本所需的核心功能。目标是快速上线一个实用工具，帮助开发和运维团队：

- **能看到基本盘**: 知道有多少访问，性能大概如何 (概览页)。
- **能定位 JS 错误**: 发现最常见的错误，并通过 SourceMap、行为栈和录屏理解错误原因和复现路径 (错误列表与详情)。这是监控系统解决问题的关键闭环。
- **能感知性能问题**: 了解核心性能指标和突出的慢页面/资源错误 (性能概览)。

## 2. 目标用户

- 前端开发工程师
- 运维工程师
- 项目负责人/技术经理

## 3. 核心功能需求

### 3.1 概览页 (Dashboard)

**目标**: 提供应用核心指标的快速概览，了解整体运行状态和主要问题趋势。

**功能点**:

1.  **时间范围选择器**:
    - 提供下拉选项，支持选择数据统计的时间范围。
    - 选项包括：**今日、昨日、最近 7 天、最近 1 个月、最近 3 个月**。
    - 选择的时间范围将应用于本页面所有数据展示。
2.  **核心指标卡片**:
    - 展示所选时间范围内的以下指标：
      - **PV (页面访问量)**: 总数。
      - **UV (独立访客数)**: 总数。
      - **JS 错误数**: 总数。
      - **LCP (最大内容绘制) 均值**: 平均 LCP 时间（单位：毫秒或秒）。
3.  **JS 错误趋势图**:
    - 展示所选时间范围内（按天聚合），JS 错误数量的变化趋势折线图。
4.  **Top 5 JS 错误列表**:
    - 展示所选时间范围内，发生次数最多的 5 个聚合后的 JS 错误。
    - 每条错误显示：错误信息摘要、发生次数。
    - 点击可跳转至对应的错误详情页。

### 3.2 错误监控 (Error Tracking)

**目标**: 集中展示、分析和定位 JS 错误，提供解决问题所需的上下文信息。

**功能点**:

1.  **JS 错误列表**:
    - 以列表形式展示聚合后的 JS 错误。
    - **聚合规则**: 优先按错误信息 (message) 和错误类型 (type) 聚合。
    - **列表字段**:
      - 错误信息摘要
      - 发生次数
      - 影响用户数
      - 首次发生时间
      - 最后发生时间
    - **筛选**: 支持按时间范围筛选 (使用与概览页相同的选择器)。
    - **排序**: 支持按发生次数、影响用户数、首次/最后发生时间排序。
    - 点击列表项进入错误详情页。
2.  **错误详情页**:
    - **基本信息**:
      - 错误类型 (Type)
      - 完整错误信息 (Message)
      - 发生页面 URL
      - 首次/最后发生时间
      - 发生次数 / 影响用户数
    - **SourceMap 还原**:
      - **(核心)** 展示通过 SourceMap 还原后的、可读的 **错误堆栈 (Stack Trace)** 信息。
      - 高亮显示错误发生的代码行。
      - 若无对应 SourceMap 或还原失败，则显示原始堆栈。
    - **用户行为栈 (Behavior Stack)**:
      - **(核心)** 展示该错误发生前，由 `behaviorStack` 插件记录的用户操作序列（如点击、页面跳转、API 请求等），帮助理解用户路径。
      - 按时间倒序排列。
    - **会话录屏回放 (rrweb)**:
      - **(核心)** 如果该错误关联了 `rrweb` 录屏数据：
        - 嵌入 `rrweb-player` 播放器。
        - 提供播放、暂停、进度条拖动功能。
        - 允许用户回放错误发生前后的用户界面操作录屏。
    - **环境信息**:
      - 浏览器 (名称 + 版本)
      - 操作系统 (名称 + 版本)
      - 设备类型 (PC/Mobile)
      - (可选) IP 地址 / 地理位置

### 3.3 性能概览 (Performance)

**目标**: 提供核心性能指标的概览，帮助识别主要的性能问题点。

**功能点**:

1.  **时间范围选择器**:
    - 与概览页共用或独立设置，影响本页面数据。选项同 3.1.1。
2.  **核心 Web Vitals 指标**:
    - 展示所选时间范围内以下指标的 **平均值** 或 **P75 分位值**：
      - **LCP (最大内容绘制)**
      - **FCP (首次内容绘制)**
3.  **Top 5 慢页面列表**:
    - 展示所选时间范围内，按 LCP (或 FCP) 指标排序，加载最慢的 5 个页面 URL。
    - 显示页面 URL 和对应的 LCP/FCP 值。
4.  **资源加载错误列表**:
    - 展示所选时间范围内，加载失败的资源 URL 列表。
    - 显示资源 URL 和错误类型（如 404, net::ERR_CONNECTION_REFUSED）。

### 3.4 SourceMap 管理

**目标**: 允许用户上传 SourceMap 文件，以便在错误详情中进行堆栈还原。

**功能点**:

1.  **SourceMap 上传**:
    - 提供一个界面，允许用户上传 `.map` 文件。
    - 上传时需要关联对应的 **应用标识 (`appId`)** 。
    - (后端需要存储 SourceMap 文件，并建立 appId -> map 文件的映射关系)。

### 3.5 设置 (Settings)

**目标**: 提供基本的项目信息展示和配置入口。

**功能点**:

1.  **项目信息**:
    - 显示当前正在查看的数据所属的 **应用标识 (`appId`)**。
    - (可选) 显示 SDK 配置的上报地址 (`reportUrl`)。
2.  **项目切换 (如果支持多项目)**:
    - 如果后端和整体设计支持管理多个项目，此处提供下拉列表或其他方式切换当前查看的项目 (`appId`)。

## 4. 通用功能

### 4.1 时间范围选择

- 如 3.1.1 所述，提供统一或各模块独立的时间范围选择器，支持预设选项（今日、昨日、近 7 天、近 1 月、近 3 月）。

## 5. 数据依赖

本数据大屏强依赖 `fe-monitor-sdk` 上报的数据。核心依赖的数据类型 (`dataType`) 包括：

- `pv`: 用于 PV/UV 统计。
- `error`: 主要用于 JS 错误监控 (`jsError` 插件类型)。也可能包含 `resourceError`, `httpError`。
- `performance`: 用于性能指标计算 (如 `pageLoad`, `firstPaint`, `firstContentfulPaint`, `largestContentfulPaint`, `resourceLoad`)。
- `behaviorStack`: 用于错误详情中的用户行为栈展示。
- `recording`: 用于错误详情中的 rrweb 录屏回放。

后端需要能够接收、存储、查询和聚合这些类型的数据。

## 6. 非功能需求

- **易用性**: 界面简洁直观，操作符合用户习惯。
- **性能**: 页面加载和数据查询响应迅速，避免长时间等待。
- **准确性**: 数据展示和计算准确无误，SourceMap 还原可靠。
- **兼容性**: 支持主流现代浏览器（Chrome, Firefox, Edge, Safari 最新版本）。
